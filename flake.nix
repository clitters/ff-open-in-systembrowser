{\n  description = "Firefox addon to open links in system default browser";\n\n  inputs = {\n    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";\n    flake-utils.url = "github:numtide/flake-utils";\n  };\n\n  outputs = { self, nixpkgs, flake-utils }: (flake-utils.lib.eachDefaultSystem (system: let pkgs = nixpkgs.legacyPackages.${system}; in { packages = { # Native messaging host package native-host = pkgs.stdenv.mkDerivation { pname = "ff-open-in-systembrowser-host"; version = "1.0.0";\n\n            src = ./host;\n\n            nativeBuildInputs = [ pkgs.makeWrapper ]; buildInputs = [ pkgs.python3 ];\n\n            installPhase = '' mkdir -p $out/bin $out/lib/mozilla/native-messaging-hosts\n\n              # Install Python script\n              cp open_in_systembrowser.py $out/bin/\n              chmod +x $out/bin/open_in_systembrowser.py\n\n              # Wrap with Python interpreter\n              wrapProgram $out/bin/open_in_systembrowser.py \n                --prefix PATH : ${pkgs.lib.makeBinPath [ pkgs.xdg-utils  # For xdg-open on Linux ]} \n\n              # Generate manifest\n              substitute ${./host/open_in_systembrowser.json.template} \n                $out/lib/mozilla/native-messaging-hosts/open_in_systembrowser.json \n                --replace "HOST_PATH" "$out/bin/open_in_systembrowser.py"\n            '';\n\n            meta = with pkgs.lib; {\n              description = "Native messaging host for opening URLs in system browser";\n              license = licenses.mit;\n              platforms = platforms.linux ++ platforms.darwin;\n            };\n          };\n\n          # Firefox addon package\n          addon = pkgs.stdenv.mkDerivation { pname = "ff-open-in-systembrowser-addon"; version = "1.0.0";\n\n            src = ./.;\n\n            nativeBuildInputs = [ pkgs.zip ];\n\n            buildPhase = '' mkdir -p build cd build cp ${./manifest.json} manifest.json cp ${./background.js} background.js mkdir -p icons # Add placeholder icons if they don't exist touch icons/icon-48.png icons/icon-96.png zip -r ../ff-open-in-systembrowser.xpi . cd .. '';\n\n            installPhase = '' mkdir -p $out cp ff-open-in-systembrowser.xpi $out/ '';\n\n            meta = with pkgs.lib; {\n              description = "Firefox addon to open links in system browser";\n              license = licenses.mit;\n              platforms = platforms.all;\n            };\n          };\n\n          default = self.packages.${pkgs.system}.native-host;\n        };\n      })) // { # NixOS module nixosModules.default = { config, lib, pkgs, ... }: with lib; let cfg = config.programs.firefox-open-in-systembrowser; in { options.programs.firefox-open-in-system-browser = { enable = mkEnableOption "Firefox open in system browser addon"; };\n\n          config = mkIf cfg.enable {\n            environment.systemPackages = [ self.packages.${pkgs.system}.native-host ];\n\n            # Install native messaging host manifest system-wide\n            environment.etc."mozilla/native-messaging-hosts/open_in_systembrowser.json".source = "${self.packages.${pkgs.system}.native-host}/lib/mozilla/native-messaging-hosts/open_in_systembrowser.json";\n          };\n        };\n\n      # Home Manager module for per-user installation homeManagerModules.default = { config, lib, pkgs, ... }: with lib; let cfg = config.programs.firefox.extensions.openInSystemBrowser; in { options.programs.firefox.extensions.openInSystemBrowser = { enable = mkEnableOption "Firefox open in system browser addon"; };\n\n          config = mkIf cfg.enable {\n            home.packages = [ self.packages.${pkgs.system}.native-host ];\n\n            # Install native messaging host manifest\n            home.file.".mozilla/native-messaging-hosts/open_in_systembrowser.json".source = "${self.packages.${pkgs.system}.native-host}/lib/mozilla/native-messaging-hosts/open_in_systembrowser.json";\n\n            # For NUR Firefox addons compatibility\n            programs.firefox.extensions = [ self.packages.${pkgs.system}.addon ];\n          };\n        };\n\n      # Overlay for NUR compatibility overlays.default = final: prev: { firefox-addons = (prev.firefox-addons or {}) // { open-in-systembrowser = self.packages.${prev.system}.addon; }; };\n    }; }